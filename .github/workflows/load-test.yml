name: 🏋️‍♂️ Local k6 Load Test

# Only for local dev stack, no AWS/cloud involved.
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  k6-local:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Build backend JAR (backend needs to be ready for Compose to run it)
      - name: 🔨 Build backend
        working-directory: backend
        run: ./gradlew bootJar --no-daemon

      # Start local backend + db via Docker Compose
      - name: ▶️ Spin up dev stack
        run: docker compose up -d

      - name: ▶️ Spin up local backend + db
        run: docker compose up -d

      - name: ⏳ Wait until backend is healthy
        run: |
          for i in {1..30}; do
            echo "Trying http://localhost:8080/healthz (try $i)"
            if curl -fs http://localhost:8080/healthz; then
              echo "Backend is live ✅"
              exit 0
            fi
            sleep 2
          done
          echo "Backend failed to become healthy ❌"
          exit 1

      - name: 🧪 Run k6 Load Test
        run: |
          docker run --rm -i \
            -e BASE_URL=http://localhost:8080 \
            -v ${{ github.workspace }}/monitoring/k6:/scripts \
            grafana/k6 run /scripts/loadtest.js
